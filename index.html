<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pilot Effort Score — Full Calculator</title>
  <meta name="description" content="Pilot Effort Score (PES) — mobile-first calculator with full metrics, color-coded result, and email report via mailto. Ready for GitHub Pages."/>
  <style>
    /* Mobile-first, clean UI */
    :root{
      --bg: #0b1220;
      --card: #0f1726;
      --muted: #9aa4b2;
      --accent: #3b82f6;
      --glass: rgba(255,255,255,0.03);
      --good: #10b981;
      --warn: #f59e0b;
      --caution: #f97316;
      --bad: #ef4444;
      --text: #e6eef6;
      --radius: 12px;
    }
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;background: linear-gradient(180deg,#071025 0%, #051123 100%);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    .container{max-width:980px;margin:16px auto;padding:12px;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:12px;box-shadow:0 8px 30px rgba(3,7,18,0.6);border:1px solid rgba(255,255,255,0.03)}
    label.section-title{font-weight:600;font-size:13px;margin-bottom:8px;display:block}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .col{flex:1;min-width:120px}
    input[type="number"], input[type="text"], input[type="email"], select, textarea, input[type="date"], input[type="time"]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:14px;box-sizing:border-box}
    textarea{min-height:84px;resize:vertical;padding-top:10px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px;color:var(--muted)}
    .btn{display:inline-block;background:linear-gradient(180deg,var(--accent),#2563eb);color:white;padding:12px 14px;border-radius:12px;border:none;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(59,130,246,0.12)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:10px;color:var(--text);cursor:pointer}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .meter{height:14px;border-radius:10px;background:rgba(255,255,255,0.03);overflow:hidden}
    .meter > i{display:block;height:100%;background:linear-gradient(90deg,#06b6d4,#3b82f6);width:0%}
    .result-card{padding:14px;border-radius:12px;text-align:center}
    .score{font-size:36px;font-weight:800;margin:6px 0}
    .label{display:inline-block;padding:8px 10px;border-radius:999px;font-weight:700}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .input-group{display:flex;gap:8px}
    .chip{background:rgba(255,255,255,0.02);padding:8px;border-radius:10px;font-size:13px}
    footer.info{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}
    @media(min-width:880px){ .grid{grid-template-columns:1fr 360px;} }
    /* touch targets */
    input,select,button,textarea{touch-action:manipulation}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Pilot Effort Score (PES)</h1>
        <p class="lead">Full calculator with every metric, color-coded result, and one-click email report. Mobile-first and iPhone-ready.</p>
      </div>
      <div class="small muted" style="margin-left:auto">Ready for GitHub Pages</div>
    </header>

    <div class="grid">
      <!-- main form -->
      <div class="card" id="formCard">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="small muted">Enter flight-day details</div>
          <div class="chip small">Estimated time: 1–2 min</div>
        </div>

        <div style="margin-bottom:12px">
          <label class="section-title">1) Report & Release</label>
          <div class="row" style="gap:8px">
            <div class="col"><div class="small muted">Report date</div><input type="date" id="reportDate"></div>
            <div style="width:120px"><div class="small muted">Report time</div><input type="time" id="reportTime" value="06:00"></div>
            <div class="col"><div class="small muted">Release date</div><input type="date" id="releaseDate"></div>
            <div style="width:120px"><div class="small muted">Release time</div><input type="time" id="releaseTime" value="18:00"></div>
          </div>
          <div class="small muted" style="margin-top:8px">If you don't enter dates, duty length won't be scored.</div>
        </div>

        <div style="margin-bottom:12px">
          <label class="section-title">2) Operational workload</label>
          <div class="row">
            <div class="col"><div class="small muted">Number of legs</div><input type="number" id="legs" min="1" value="1"></div>
            <div style="width:140px"><div class="small muted">Avg turn time (min)</div><input type="number" id="turnTime" min="0" value="90"></div>
            <div style="width:160px"><div class="small muted">Airspace/terrain</div>
              <select id="airComplex">
                <option value="0">None</option>
                <option value="3">Some</option>
                <option value="6">High</option>
              </select>
            </div>
            <div style="width:160px"><div class="small muted">Crew</div>
              <select id="crewType">
                <option value="2">Two-pilot</option>
                <option value="7">Single-pilot IFR</option>
              </select>
            </div>
          </div>
        </div>

        <div style="margin-bottom:12px">
          <label class="section-title">3) Weather & environment</label>
          <div class="row">
            <div class="col">
              <div class="small muted">IMC prevalence</div>
              <select id="imc">
                <option value="0">VMC all legs</option>
                <option value="5">Some IMC</option>
                <option value="10">Most / All IMC</option>
              </select>
            </div>
            <div style="width:140px">
              <div class="small muted">Approaches to mins?</div>
              <select id="toMins"><option value="0">None</option><option value="7">One or more</option></select>
            </div>
            <div style="width:160px">
              <div class="small muted">Hazards</div>
              <select id="hazards"><option value="0">None / light</option><option value="4">Moderate</option><option value="8">Severe</option></select>
            </div>
            <div style="width:160px">
              <div class="small muted">Crosswind factor</div>
              <select id="xwind"><option value="0">Low (&lt;1/3)</option><option value="3">Moderate</option><option value="5">High (&gt;2/3)</option></select>
            </div>
          </div>
        </div>

        <div style="margin-bottom:12px">
          <label class="section-title">4) Disruptions & constraints</label>
          <div class="row">
            <div class="col"><div class="small muted">ATC delays / holding</div><select id="atc"><option value="0">None / minor</option><option value="3">Some</option><option value="5">Frequent / significant</option></select></div>
            <div style="width:160px"><div class="small muted">MEL / automation</div><select id="mel"><option value="0">None</option><option value="3">Minor</option><option value="6">Major</option></select></div>
            <div style="width:160px"><div class="small muted">Ops pressure</div><select id="pressure"><option value="0">Low</option><option value="2">Moderate</option><option value="4">High</option></select></div>
          </div>
        </div>

        <div style="margin-bottom:12px">
          <label class="section-title">5) Human factors & recovery</label>
          <div class="row">
            <div class="col"><div class="small muted">Breaks & nutrition</div><select id="meals"><option value="0">Proper meal & breaks</option><option value="3">Missed meal OR no break</option><option value="5">Both missed</option></select></div>
            <div style="width:140px"><div class="small muted">Avg flight hours</div><input type="number" id="fltHours" min="0" step="0.1" placeholder="optional"></div>
          </div>
        </div>

        <div style="margin-bottom:12px">
          <label class="section-title">6) Scheduling Stability Modifier (SSM)</label>
          <div class="small muted">How far ahead was the plan firm?</div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <select id="ssm">
              <option value="0">≥ 7 days</option>
              <option value="3">48–168 hrs (2–7d)</option>
              <option value="6">24–48 hrs</option>
              <option value="8">&lt;24 hrs (night-before)</option>
              <option value="10">&lt;12 hrs / pulled into WOCL</option>
            </select>
          </div>
        </div>

        <div style="margin-bottom:12px">
          <label class="section-title">7) Route Change / Diversion (RCM)</label>
          <div class="small muted">Select any same-day changes (RCM caps at +10)</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <label><input type="checkbox" id="ownerSwap"> Owner-requested destination swap (same day) +3</label>
            <label><input type="number" id="addedStops" min="0" max="2" value="0" style="width:80px"> Added intermediate stops day-of (+3 each, max +6)</label>
            <label><input type="checkbox" id="weatherPlannedAlt"> WX diversion to planned alternate +4</label>
            <label><input type="checkbox" id="weatherUnplanned"> Diversion to *unplanned* field +6</label>
            <label><input type="number" id="extraDiverts" min="0" max="2" value="0" style="width:80px"> Additional diversions beyond first (+2 each, capped)</label>
          </div>
        </div>

        <div style="margin-bottom:12px">
          <label class="section-title">8) Notes & Debrief (optional)</label>
          <textarea id="notes" placeholder="What drove effort? e.g. early call, missed lunch, unplanned diversion, MEL"></textarea>
        </div>

        <div class="controls" style="margin-top:8px">
          <button class="btn" onclick="compute()">Compute PES</button>
          <button class="btn-ghost" onclick="fillExample('easy')">Fill: Easy VFR</button>
          <button class="btn-ghost" onclick="fillExample('ugly')">Fill: Long IFR Day</button>
          <button class="btn-ghost" onclick="resetForm()">Reset</button>
        </div>
      </div>

      <!-- result panel -->
      <aside class="card">
        <div class="flex-between" style="margin-bottom:8px">
          <div>
            <div class="small muted">Final PES</div>
            <div class="score" id="finalScore">0</div>
            <div class="small muted">out of 100</div>
          </div>
          <div style="text-align:right">
            <div class="small muted">Label</div>
            <div id="label" class="label" style="margin-top:8px;background:rgba(255,255,255,0.02);">—</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="small muted">Breakdown</div>
          <div style="display:grid;grid-template-columns:1fr 70px;gap:6px;margin-top:8px">
            <div class="small muted">Base PES</div><div id="baseVal" style="text-align:right">0</div>
            <div class="small muted">SSM</div><div id="ssmVal" style="text-align:right">0</div>
            <div class="small muted">RCM</div><div id="rcmVal" style="text-align:right">0</div>
            <div class="small muted">Crew add-on</div><div id="crewVal" style="text-align:right">0</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small muted">Visual</div>
          <div class="meter" style="margin-top:8px"><i id="meterFill" style="width:0%"></i></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" onclick="exportJSON()">Export JSON</button>
          <button class="btn-ghost" onclick="exportCSV()">Export CSV</button>
        </div>

        <div style="margin-top:12px">
          <label class="small muted">Email report (opens your mail client)</label>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <input type="email" id="email" placeholder="pilot@domain.com" style="flex:1" />
            <button class="btn" onclick="sendEmail()">Send Report</button>
          </div>
          <div class="small muted" style="margin-top:8px">This uses <code>mailto:</code> to pre-fill an email; your mail app will open with the report ready to send.</div>
        </div>

        <footer class="info">Copy this file to <strong>index.html</strong> in a public GitHub repo and enable Pages (branch: main, folder: /). View on iPhone at <code>https://&lt;user&gt;.github.io/&lt;repo&gt;/</code></footer>
      </aside>
    </div>
  </div>

<script>
/* Helper functions */
function parseDateTime(dId,tId){ const d=document.getElementById(dId).value; const t=document.getElementById(tId).value||'00:00'; if(!d) return null; return new Date(d + 'T' + t); }
function minutesBetween(a,b){ if(!a||!b) return 0; return Math.max(0, Math.round((b - a)/60000)); }

/* Compute PES */
function compute(){
  // read inputs
  const reportDT=parseDateTime('reportDate','reportTime');
  const releaseDT=parseDateTime('releaseDate','releaseTime');
  const legs = Number(document.getElementById('legs').value) || 1;
  const turnTime = Number(document.getElementById('turnTime').value) || 90;
  const airComplex = Number(document.getElementById('airComplex').value) || 0;
  const crewType = Number(document.getElementById('crewType').value) || 2;
  const imc = Number(document.getElementById('imc').value) || 0;
  const toMins = Number(document.getElementById('toMins').value) || 0;
  const hazards = Number(document.getElementById('hazards').value) || 0;
  const xwind = Number(document.getElementById('xwind').value) || 0;
  const atc = Number(document.getElementById('atc').value) || 0;
  const mel = Number(document.getElementById('mel').value) || 0;
  const pressure = Number(document.getElementById('pressure').value) || 0;
  const meals = Number(document.getElementById('meals').value) || 0;
  const ssm = Number(document.getElementById('ssm').value) || 0;
  const notes = document.getElementById('notes').value || '';

  // RCM
  const ownerSwap = document.getElementById('ownerSwap').checked;
  const addedStops = Math.min(2, Number(document.getElementById('addedStops').value) || 0);
  const weatherPlanned = document.getElementById('weatherPlannedAlt').checked;
  const weatherUnplanned = document.getElementById('weatherUnplanned').checked;
  const extraDiverts = Math.min(2, Number(document.getElementById('extraDiverts').value) || 0);

  // 1) Schedule & circadian
  let dutyMins = 0;
  if(reportDT && releaseDT) dutyMins = minutesBetween(reportDT, releaseDT);
  let dutyScore = 0;
  if(dutyMins <= 360) dutyScore = 0;
  else if(dutyMins <= 480) dutyScore = 5;
  else if(dutyMins <= 600) dutyScore = 10;
  else if(dutyMins <= 720) dutyScore = 15;
  else dutyScore = 20;
  let circ = 0;
  if(reportDT){ const hr = reportDT.getHours(); if(hr>=7 && hr<=10) circ=0; else if(hr>=5 && hr<=6) circ=5; else if(hr>=3 && hr<=4) circ=10; else if(hr>=23 || hr<=2) circ=15; }
  const scheduleCircScore = Math.min(35, dutyScore + circ);

  // 2) Operational workload (max 23)
  let legsScore = 0;
  if(legs === 1) legsScore = 0; else if(legs === 2) legsScore = 3; else if(legs === 3) legsScore = 6; else if(legs === 4) legsScore = 9; else if(legs >= 5) legsScore = 12;
  let turnScore = (turnTime >= 75) ? 0 : (turnTime >= 45 ? 3 : 5);
  let airComplexScore = airComplex;
  const opWorkScore = Math.min(23, legsScore + turnScore + airComplexScore);

  // 3) Weather & environment (max 25)
  const imcScore = imc;
  const toMinsScore = toMins;
  const hazardsScore = hazards;
  const xwindScore = xwind;
  const weatherScore = Math.min(25, imcScore + toMinsScore + hazardsScore + xwindScore);

  // 4) Disruptions & constraints (max 12)
  const atcScore = atc;
  const melScore = mel;
  const pressureScore = pressure;
  const disruptionsScore = Math.min(12, atcScore + melScore + pressureScore);

  // 5) Human factors & recovery (max 5)
  const humanScore = meals;

  // crew add-on (single-pilot IFR adds +5)
  const crewAdd = (crewType === 7) ? 5 : 0;

  // base PES
  const basePES = Math.min(100, scheduleCircScore + opWorkScore + weatherScore + disruptionsScore + humanScore);

  // compute RCM
  let rcm = 0;
  if(ownerSwap) rcm += 3;
  if(addedStops > 0) rcm += Math.min(6, addedStops * 3);
  if(weatherPlanned) rcm += 4;
  if(weatherUnplanned) rcm += 6;
  if(extraDiverts > 0) rcm += Math.min(4, extraDiverts * 2);
  if(rcm > 10) rcm = 10; // cap

  // final
  let final = Math.min(100, basePES + Number(ssm) + rcm + crewAdd);

  // label and color
  let labelText = ''; let color = '';
  if(final <= 20){ labelText = 'Cushion / Easy day'; color = 'var(--good)'; }
  else if(final <= 40){ labelText = 'Routine'; color = '#84cc16'; } // lime-400
  else if(final <= 60){ labelText = 'Taxing'; color = 'var(--warn)'; }
  else if(final <= 80){ labelText = 'Hard day'; color = 'var(--caution)'; }
  else { labelText = 'Max effort'; color = 'var(--bad)'; }

  // update UI
  document.getElementById('finalScore').textContent = final;
  const lab = document.getElementById('label');
  lab.textContent = labelText; lab.style.background = color; lab.style.color = '#071028';
  document.getElementById('meterFill').style.width = final + '%';
  document.getElementById('baseVal').textContent = basePES;
  document.getElementById('ssmVal').textContent = ssm;
  document.getElementById('rcmVal').textContent = rcm;
  document.getElementById('crewVal').textContent = crewAdd;

  // store last computed payload for exports/email
  window._lastReport = {
    timestamp: new Date().toISOString(),
    reportDate: document.getElementById('reportDate').value,
    reportTime: document.getElementById('reportTime').value,
    releaseDate: document.getElementById('releaseDate').value,
    releaseTime: document.getElementById('releaseTime').value,
    legs, turnTime, airComplex, crewType, imc, toMins, hazards, xwind, atc, mel, pressure, meals,
    ssm, ownerSwap, addedStops, weatherPlanned, weatherUnplanned, extraDiverts, notes, basePES, rcm, crewAdd, final, labelText
  };
}

/* Export helpers */
function exportJSON(){
  compute();
  const p = window._lastReport || {}; const blob = new Blob([JSON.stringify(p, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'pes-report.json'; a.click(); URL.revokeObjectURL(url);
}
function exportCSV(){
  compute();
  const p = window._lastReport || {};
  const keys = Object.keys(p); const csv = keys.join(',') + '\\n' + keys.map(k=>JSON.stringify(String(p[k]).replace(/\\n/g,' '))).join(',');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='pes-report.csv'; a.click(); URL.revokeObjectURL(url);
}

/* Email via mailto */
function sendEmail(){
  compute();
  const p = window._lastReport || {};
  const to = document.getElementById('email').value || '';
  if(!to){ alert('Enter an email address to send the report to.'); return; }
  const subject = encodeURIComponent('PES Report — ' + (p.reportDate || new Date().toISOString().slice(0,10)) );
  const bodyLines = [
    'Pilot Effort Score (PES) Report',
    'Generated: ' + (p.timestamp || new Date().toISOString()),
    '',
    'Final PES: ' + p.final + ' (' + p.labelText + ')',
    '',
    'Breakdown:',
    '  Base PES: ' + p.basePES,
    '  SSM: ' + p.ssm,
    '  RCM: ' + p.rcm,
    '  Crew add-on: ' + p.crewAdd,
    '',
    'Inputs:',
    '  Report: ' + (p.reportDate || '') + ' ' + (p.reportTime || ''),
    '  Release: ' + (p.releaseDate || '') + ' ' + (p.releaseTime || ''),
    '  Legs: ' + (p.legs || ''),
    '  Avg turn (min): ' + (p.turnTime || ''),
    '  IMC score: ' + (p.imc || ''),
    '  To mins: ' + (p.toMins || ''),
    '  Hazards: ' + (p.hazards || ''),
    '  Crosswind: ' + (p.xwind || ''),
    '  ATC: ' + (p.atc || ''),
    '  MEL: ' + (p.mel || ''),
    '  Pressure: ' + (p.pressure || ''),
    '  Meals: ' + (p.meals || ''),
    '  SSM: ' + (p.ssm || ''),
    '  RCM - ownerSwap: ' + (p.ownerSwap ? 'yes' : 'no') + ', addedStops: ' + (p.addedStops || 0) + ', weatherPlanned: ' + (p.weatherPlanned ? 'yes' : 'no') + ', weatherUnplanned: ' + (p.weatherUnplanned ? 'yes' : 'no') + ', extraDiverts: ' + (p.extraDiverts || 0),
    '',
    'Notes:',
    p.notes || '',
    '',
    '---',
    'This report was generated using a client-side PES calculator.',
  ];
  const body = encodeURIComponent(bodyLines.join('\\n'));
  const mailto = 'mailto:' + encodeURIComponent(to) + '?subject=' + subject + '&body=' + body;
  window.location.href = mailto;
}

/* Example fills */
function fillExample(which){
  resetForm();
  const today = new Date().toISOString().slice(0,10);
  if(which === 'easy'){
    document.getElementById('reportDate').value = today; document.getElementById('reportTime').value='12:00';
    document.getElementById('releaseDate').value = today; document.getElementById('releaseTime').value='18:00';
    document.getElementById('legs').value=1; document.getElementById('turnTime').value=90; document.getElementById('imc').value='0'; document.getElementById('meals').value='0'; document.getElementById('ssm').value='0';
  } else {
    document.getElementById('reportDate').value = today; document.getElementById('reportTime').value='06:00';
    document.getElementById('releaseDate').value = today; document.getElementById('releaseTime').value='19:00';
    document.getElementById('legs').value=4; document.getElementById('turnTime').value=30; document.getElementById('imc').value='10'; document.getElementById('toMins').value='7';
    document.getElementById('hazards').value='8'; document.getElementById('xwind').value='3'; document.getElementById('ssm').value='8'; document.getElementById('meals').value='5'; document.getElementById('airComplex').value='3'; document.getElementById('atc').value='3'; document.getElementById('pressure').value='2';
    document.getElementById('ownerSwap').checked=false; document.getElementById('addedStops').value='0'; document.getElementById('weatherPlannedAlt').checked=false; document.getElementById('weatherUnplanned').checked=false; document.getElementById('extraDiverts').value='0';
  }
  compute();
}

function resetForm(){
  document.querySelectorAll('input,select,textarea').forEach(el=>{
    if(el.type==='checkbox') el.checked=false;
    else if(el.tagName==='SELECT') el.selectedIndex=0;
    else if(el.type==='number') {
      if(el.id === 'legs') el.value = 1;
      else if(el.id === 'turnTime') el.value = 90;
      else if(el.id === 'addedStops' || el.id==='extraDiverts') el.value = 0;
      else el.value='';
    }
    else if(el.type==='email') el.value='';
    else if(el.type!=='date' && el.type!=='time') el.value='';
  });
  // sensible defaults
  document.getElementById('legs').value=1; document.getElementById('turnTime').value=90; document.getElementById('crewType').value=2; document.getElementById('reportTime').value='06:00'; document.getElementById('releaseTime').value='18:00'; document.getElementById('imc').value='0'; document.getElementById('meals').value='0'; document.getElementById('ssm').value='0';
  document.getElementById('finalScore').textContent='0'; document.getElementById('label').textContent='—'; document.getElementById('meterFill').style.width='0%';
}

resetForm();
</script>
</body>
</html>
